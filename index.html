<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>David Kendall Casey</title>
  <link rel="stylesheet" href="stylesheet.css">
  <!-- Font Awesome for play/pause icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  >
  <style>
    /* Audio player button styles */
    #play-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #4a4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      vertical-align: middle;
    }
    #play-button:hover {
      background: #333;
      transform: scale(1.05);
    }
    #play-button.playing {
      background: #3a3a3a;
    }
    .quote-attribution {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .divider {
      width: 20%;
      margin: 50px auto;
      border: none;
      height: 0.5px;
      background-color: crimson;
    }
  </style>
</head>
<body>
  <header>
    <h1><i>David Kendall Casey</i></h1>
    <h3 class="subtitle">Commonplace Book</h3>
    <div class="search-container">
      <form class="search-form">
        <input
          type="search"
          class="search-input"
          placeholder="Search entire site..."
          aria-label="Search"
        >
      </form>
      <div class="search-results" id="searchResults"></div>
    </div>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="commonplace.html">Index</a>
  </nav>

  <h2>Daily selection</h2>
  <main class="container">
    <div id="quote-of-the-day">
      <p id="quote-header"></p>
      <blockquote id="quote-text"></blockquote>
      <div class="quote-attribution">
        <p id="quote-source"></p>
        <button id="play-button" title="Listen to quote">
          <i id="play-icon" class="fas fa-play"></i>
        </button>
      </div>
      <hr class="divider">
    </div>
  </main>
	  <script>
		async function displayDailyQuote() {
		  // List of page URLs
		  const pages = [
			'on-animals.html','on-art-and-creativity.html','on-age.html',
			'on-beauty.html','on-benevolence.html','on-crime-and-punishment.html',
			'on-culture-and-politics.html','on-existence.html','on-death.html',
			'on-education.html','on-friendship.html','on-greatness.html',
			'on-hate.html','on-health-illness-medicine.html','on-morality.html',
			'on-hope.html','on-introversion.html','on-joy.html',
			'on-language.html','on-love.html','on-manners.html',
			'on-justice-and-mercy.html','on-mind.html','on-money-and-wealth.html',
			'on-the-past.html','on-philosophy.html','on-race-and-racism.html',
			'on-reading.html','on-the-sublime.html','on-suffering.html',
			'on-technology.html','on-truth-and-knowledge.html',
			'on-war-and-violence.html','on-work.html','on-writing.html'
		  ];
		  
		  try {
			// First try - get from localStorage if available for today
			const today = new Date().toISOString().split('T')[0];
			let stored = JSON.parse(localStorage.getItem('dailyQuote') || '{}');
			
			// Check if we have a valid quote for today or force refresh
			const forceRefresh = true; // Set to true to always get a new quote (for testing)
			if (!forceRefresh && stored.date === today && stored.quoteHTML) {
			  displayQuote(stored.quoteHTML, stored.sourceText, stored.pageName, stored.pageURL);
			  console.log("Retrieved quote from localStorage");
			  return;
			}
			
			// If not in storage or forcing refresh, pick a random page
			const pageIndex = Math.floor(Math.random() * pages.length);
			const page = pages[pageIndex];
			console.log("Fetching quote from page:", page);
			
			// Fetch the page content
			const response = await fetch(page);
			if (!response.ok) {
			  throw new Error(`Failed to fetch ${page}: ${response.status}`);
			}
			
			const html = await response.text();
			const parser = new DOMParser();
			const doc = parser.parseFromString(html, 'text/html');
			
			// Select all quote entries
			const quoteEntries = doc.querySelectorAll('.quote-entry');
			if (!quoteEntries || quoteEntries.length === 0) {
			  throw new Error(`No quotes found in ${page}`);
			}
			
			// Pick a random quote
			const randomIndex = Math.floor(Math.random() * quoteEntries.length);
			const randomQuote = quoteEntries[randomIndex];
			
			// Extract quote details
			const quoteHTML = randomQuote.querySelector('blockquote').innerHTML.trim();
			const sourceElement = randomQuote.querySelector('.source');
			const sourceText = sourceElement ? sourceElement.textContent.trim() : 'Unknown Source';
			
			// Format the page name for display
			const pageName = page.replace(/\.html$/, '').replace(/-/g, ' ');
			const formattedPageName = pageName.charAt(0).toUpperCase() + pageName.slice(1);
			
			// Save to localStorage
			const payload = { 
			  date: today,
			  quoteHTML: quoteHTML,
			  sourceText: sourceText,
			  pageName: formattedPageName,
			  pageURL: page
			};
			
			localStorage.setItem('dailyQuote', JSON.stringify(payload));
			
			// Display the quote
			displayQuote(quoteHTML, sourceText, formattedPageName, page);
			console.log("New quote fetched and saved");
			
		  } catch (error) {
			console.error("Error displaying daily quote:", error);
			
			// Fallback: Display a default quote if everything fails
			displayQuote(
			  "Anything that is in the world when you're born is normal and ordinary and is just a natural part of the way the world works. Anything that's invented between when you're fifteen and thirty-five is new and exciting and revolutionary and you can probably get a career in it. Anything invented after you're thirty-five is against the natural order of things.",
			  "Douglas Adams",
			  "On Age",
			  "on-age.html"
			);
		  }
		}

		// Helper function to display the quote on the page
		function displayQuote(html, source, title, url) {
		  const quoteText = document.getElementById('quote-text');
		  const quoteSource = document.getElementById('quote-source');
		  const quoteHeader = document.getElementById('quote-header');
		  
		  if (quoteText) quoteText.innerHTML = html;
		  if (quoteSource) quoteSource.textContent = `â€” ${source}`;
		  if (quoteHeader) {
			quoteHeader.innerHTML = `From: <a href="${url}" target="_blank" style="color:inherit;text-decoration:none;">${title}</a>`;
		  }
		  
		  // Log the values that we're setting for debugging
		  console.log("Quote text:", html);
		  console.log("Quote source:", source);
		  console.log("Quote title:", title);
		}

		// 2. AUDIO PLAYBACK FIX
		// Global variable to track speech synthesis state
		let isSpeaking = false;
		let currentUtterance = null;

		function readQuoteAloud() {
		  // First, cancel any ongoing speech
		  window.speechSynthesis.cancel();
		  
		  // Get the quote text and source
		  const quoteText = document.getElementById('quote-text');
		  const sourceText = document.getElementById('quote-source');
		  
		  // Check if we have quote content
		  if (!quoteText || !quoteText.innerText || quoteText.innerText.trim() === '') {
			console.error("No quote content found to read");
			return;
		  }
		  
		  const quote = quoteText.innerText.trim();
		  const source = sourceText ? sourceText.innerText.trim() : '';
		  
		  // Toggle playback state
		  if (isSpeaking) {
			// Stop current speech if it's playing
			window.speechSynthesis.cancel();
			isSpeaking = false;
			updatePlayButton(false);
			return;
		  }
		  
		  // Create new utterance if we're starting playback
		  const utterance = new SpeechSynthesisUtterance(`${quote} ${source}`);
		  utterance.rate = 0.9;  // Slightly slower rate for better clarity
		  utterance.pitch = 1;
		  
		  // Set up event handlers for the utterance
		  utterance.onend = () => {
			isSpeaking = false;
			updatePlayButton(false);
		  };
		  
		  utterance.onerror = () => {
			console.error('Speech synthesis error occurred');
			isSpeaking = false;
			updatePlayButton(false);
		  };
		  
		  // Try to get all available voices
		  const voices = window.speechSynthesis.getVoices();
		  
		  if (voices.length > 0) {
			// First try: British male voice
			const britishMale = voices.find(voice => 
			  voice.lang === 'en-GB' && 
			  (voice.name.includes('Male') || /\bMale\b/i.test(voice.name))
			);
			
			// Second try: Any English male voice
			const englishMale = voices.find(voice => 
			  /^en/.test(voice.lang) && 
			  (voice.name.includes('Male') || /\bMale\b/i.test(voice.name))
			);
			
			// Third try: Any British voice
			const britishVoice = voices.find(voice => voice.lang === 'en-GB');
			
			// Set the best available voice
			utterance.voice = britishMale || englishMale || britishVoice || null;
			
			if (utterance.voice) {
			  console.log("Using voice:", utterance.voice.name);
			} else {
			  console.log("Using default voice (no specific voice found)");
			}
		  } else {
			console.log("No voices available yet, using default voice");
		  }
		  
		  // Start speech synthesis
		  window.speechSynthesis.speak(utterance);
		  currentUtterance = utterance;
		  isSpeaking = true;
		  updatePlayButton(true);
		}

		// Update the play button appearance
		function updatePlayButton(isPlaying) {
		  const playIcon = document.getElementById('play-icon');
		  const playBtn = document.getElementById('play-button');
		  
		  if (!playIcon || !playBtn) return;
		  
		  if (isPlaying) {
			playIcon.classList.remove('fa-play');
			playIcon.classList.add('fa-pause');
			playBtn.classList.add('playing');
		  } else {
			playIcon.classList.remove('fa-pause');
			playIcon.classList.add('fa-play');
			playBtn.classList.remove('playing');
		  }
		}

		// Handle voice loading in Chrome
		document.addEventListener('DOMContentLoaded', () => {
		  // Force load voices for Chrome
		  if (window.speechSynthesis) {
			window.speechSynthesis.getVoices();
		  }
		  
		  // Set up play button
		  const playButton = document.getElementById('play-button');
		  if (playButton) {
			playButton.addEventListener('click', () => {
			  readQuoteAloud();
			});
		  }
		  
		  // Initialize the quote display
		  displayDailyQuote();
		});

		// Add event listener for when voices are loaded (Chrome needs this)
		if (window.speechSynthesis) {
		  window.speechSynthesis.onvoiceschanged = () => {
			const voices = window.speechSynthesis.getVoices();
			console.log("Voices loaded:", voices.length);
		  };
		}
	</script>
</body>
</html>