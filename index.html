<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>David Kendall Casey</title>
  <link rel="stylesheet" href="stylesheet.css">
  <!-- Font Awesome for play/pause icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  >
  <style>
    /* Audio player button styles */
    #play-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #4a4a4a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      vertical-align: middle;
    }
    #play-button:hover {
      background: #333;
      transform: scale(1.05);
    }
    #play-button.playing {
      background: #3a3a3a;
    }
    .quote-attribution {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .divider {
      width: 20%;
      margin: 50px auto;
      border: none;
      height: 0.5px;
      background-color: crimson;
    }
  </style>
</head>
<body>
  <header>
    <h1><i>David Kendall Casey</i></h1>
    <h3 class="subtitle">Commonplace Book</h3>
    <div class="search-container">
      <form class="search-form">
        <input
          type="search"
          class="search-input"
          placeholder="Search entire site..."
          aria-label="Search"
        >
      </form>
      <div class="search-results" id="searchResults"></div>
    </div>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="commonplace.html">Index</a>
  </nav>

  <h2>Daily selection</h2>
  <main class="container">
    <div id="quote-of-the-day">
      <p id="quote-header"></p>
      <blockquote id="quote-text"></blockquote>
      <div class="quote-attribution">
        <p id="quote-source"></p>
        <button id="play-button" title="Listen to quote">
          <i id="play-icon" class="fas fa-play"></i>
        </button>
      </div>
      <hr class="divider">
    </div>
  </main>
	  <script>
	  //
	  // 1) Search‑index loading & handlers
	  //
	  let searchIndex = null;
	  window.addEventListener('load', async () => {
		try {
		  const resp = await fetch('/search-index.json');
		  searchIndex = await resp.json();
		} catch (e) {
		  console.error('Failed to load search index:', e);
		}
	  });
	  function debounce(fn, wait) {
		let t;
		return (...args) => {
		  clearTimeout(t);
		  t = setTimeout(() => fn.apply(this, args), wait);
		};
	  }
	  const debounceSearch = debounce(e => {
		const term = e.target.value;
		term.length >= 2 ? performSearch(term) : hideResults();
	  }, 300);
	  function handleSearch(evt) {
		evt.preventDefault();
		performSearch(evt.target.querySelector('input').value);
	  }
	  function performSearch(term) {
		if (!searchIndex) {
		  return displayResults([{ title:'Error', preview:'Search index not loaded.', url:'#' }]);
		}
		const re = new RegExp(term,'gi');
		const results = searchIndex
		  .filter(p => p.title.match(re) || p.content.match(re))
		  .map(p => {
			let preview = p.preview;
			const idx = p.content.toLowerCase().indexOf(term.toLowerCase());
			if (idx!==-1) {
			  const start = Math.max(0, idx-50),
					end   = Math.min(p.content.length, idx+100);
			  preview = '...'+p.content.slice(start,end)+'...';
			}
			return {
			  title:   p.title.replace(re,m=>`<span class="highlight">${m}</span>`),
			  preview: preview.replace(re,m=>`<span class="highlight">${m}</span>`),
			  url:     p.url
			};
		  }).slice(0,5);
		displayResults(results);
	  }
	  function displayResults(results) {
		const c = document.getElementById('searchResults');
		c.innerHTML = '';
		if (!results.length) {
		  c.innerHTML = '<div class="result-item">No results found</div>';
		  c.style.display = 'block';
		  return;
		}
		results.forEach(r => {
		  const d = document.createElement('div');
		  d.className = 'result-item';
		  d.innerHTML = `
			<div class="result-title">${r.title}</div>
			<div class="result-preview">${r.preview}</div>
		  `;
		  d.addEventListener('click',()=>window.location.href=r.url);
		  c.appendChild(d);
		});
		c.style.display = 'block';
	  }
	  function hideResults() {
		document.getElementById('searchResults').style.display='none';
	  }
	  document.addEventListener('click', e=> {
		if (!e.target.closest('.search-container')) hideResults();
	  });

	  //
	  // 2) Daily‑quote loader & display
	  //
	  async function displayDailyQuote() {
		const pages = [
		  'on-animals.html','on-art-and-creativity.html','on-age.html',
		  'on-beauty.html','on-benevolence.html','on-crime-and-punishment.html',
		  'on-culture-and-politics.html','on-existence.html','on-death.html',
		  'on-education.html','on-friendship.html','on-greatness.html',
		  'on-hate.html','on-health-illness-medicine.html','on-morality.html',
		  'on-hope.html','on-introversion.html','on-joy.html',
		  'on-language.html','on-love.html','on-manners.html',
		  'on-justice-and-mercy.html','on-mind.html','on-money-and-wealth.html',
		  'on-the-past.html','on-philosophy.html','on-race-and-racism.html',
		  'on-reading.html','on-the-sublime.html','on-suffering.html',
		  'on-technology.html','on-truth-and-knowledge.html',
		  'on-war-and-violence.html','on-work.html','on-writing.html'
		];
		const today = new Date().toISOString().split('T')[0];
		let stored = JSON.parse(localStorage.getItem('dailyQuote')||'{}');
		if (stored.date===today) {
		  displayQuote(stored.quoteHTML,stored.sourceText,stored.pageName,stored.pageURL);
		  return;
		}
		const page = pages[Math.floor(Math.random()*pages.length)];
		try {
		  const res = await fetch(page);
		  const txt = await res.text();
		  const doc = new DOMParser().parseFromString(txt,'text/html');
		  const list = doc.querySelectorAll('.quote-entry');
		  if (!list.length) throw new Error(`No quotes in ${page}`);
		  const entry      = list[Math.floor(Math.random()*list.length)];
		  const quoteHTML  = entry.querySelector('blockquote').innerHTML;
		  const srcEl      = entry.querySelector('.source');
		  const sourceText = srcEl? srcEl.textContent.trim() : 'Unknown Source';
		  const name       = page.replace(/\.html$/,'').replace(/-/g,' ');
		  const title      = name.charAt(0).toUpperCase()+name.slice(1);
		  const payload    = { date:today,quoteHTML,sourceText,pageName:title,pageURL:page };
		  localStorage.setItem('dailyQuote',JSON.stringify(payload));
		  displayQuote(quoteHTML,sourceText,title,page);
		} catch(e) {
		  console.error(e);
		}
	  }
	  function displayQuote(html,src,title,url) {
		document.getElementById('quote-text').innerHTML    = html;
		document.getElementById('quote-source').textContent = `— ${src}`;
		document.getElementById('quote-header').innerHTML   =
		  `From: <a href="${url}" target="_blank" style="color:inherit;text-decoration:none;">
			${title}
		   </a>`;
	  }

	  //
	  // 3) Read‑aloud
	  //
// Global variable to track speech synthesis state
let isSpeaking = false;
let currentUtterance = null;

function readQuoteAloud() {
  // Get the quote text and source
  const quote = document.getElementById('quote-text').innerText.trim();
  const src = document.getElementById('quote-source').innerText.trim();
  
  // Toggle playback state
  if (isSpeaking) {
    // Stop current speech if it's playing
    window.speechSynthesis.cancel();
    isSpeaking = false;
    updatePlayButton(false);
    return;
  }
  
  // Create new utterance if we're starting playback
  const utterance = new SpeechSynthesisUtterance(`${quote} ${src}`);
  utterance.rate = 0.9;  // Slightly slower rate for better clarity
  utterance.pitch = 1;
  
  // Handle voice selection - preferring British male voices
  let voices = [];
  
  // Get available voices
  const loadVoices = () => {
    voices = window.speechSynthesis.getVoices();
    
    // First try: British male voice
    const britishMale = voices.find(v => 
      v.lang === 'en-GB' && 
      (v.name.includes('Male') || /\bMale\b/i.test(v.name))
    );
    
    // Second try: Any English male voice
    const englishMale = voices.find(v => 
      /^en/.test(v.lang) && 
      (v.name.includes('Male') || /\bMale\b/i.test(v.name))
    );
    
    // Third try: Any British voice
    const britishVoice = voices.find(v => v.lang === 'en-GB');
    
    // Use the best available voice
    utterance.voice = britishMale || englishMale || britishVoice || null;
    
    // Only proceed with speaking if we haven't already started
    if (!isSpeaking) {
      startSpeaking(utterance);
    }
  };
  
  // Start the actual speech
  const startSpeaking = (utt) => {
    // Set up event handlers for the utterance
    utt.onend = () => {
      isSpeaking = false;
      updatePlayButton(false);
    };
    
    utt.onerror = () => {
      console.error('Speech synthesis error occurred');
      isSpeaking = false;
      updatePlayButton(false);
    };
    
    // Store the current utterance and start speaking
    currentUtterance = utt;
    window.speechSynthesis.speak(utt);
    isSpeaking = true;
    updatePlayButton(true);
  };
  
  // Check if voices are already loaded
  if (voices.length > 0) {
    loadVoices();
  } else {
    // Chrome and some browsers load voices asynchronously
    window.speechSynthesis.onvoiceschanged = loadVoices;
    
    // Handle the case where onvoiceschanged doesn't fire (fallback)
    setTimeout(() => {
      if (!isSpeaking && voices.length === 0) {
        voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
          loadVoices();
        } else {
          // Last resort - just use default voice
          startSpeaking(utterance);
        }
      }
    }, 1000);
  }
}

// Update the play button appearance
function updatePlayButton(isPlaying) {
  const playIcon = document.getElementById('play-icon');
  const playBtn = document.getElementById('play-button');
  
  if (isPlaying) {
    playIcon.classList.remove('fa-play');
    playIcon.classList.add('fa-pause');
    playBtn.classList.add('playing');
  } else {
    playIcon.classList.remove('fa-pause');
    playIcon.classList.add('fa-play');
    playBtn.classList.remove('playing');
  }
}

// Initialize event listeners when the document is ready
document.addEventListener('DOMContentLoaded', () => {
  // Set up play button click handler
  const playBtn = document.getElementById('play-button');
  if (playBtn) {
    playBtn.addEventListener('click', (e) => {
      e.preventDefault();
      readQuoteAloud();
    });
  }
});
	  // search form & input
	  document.querySelector('.search-form').addEventListener('submit', handleSearch);
	  document.querySelector('.search-input').addEventListener('keyup', debounceSearch);
	</script>
</body>
</html>